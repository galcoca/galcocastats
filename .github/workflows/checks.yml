name: Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: checks-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  wait-for-vercel:
    runs-on: ubuntu-latest
    name: Wait for Vercel
    if: github.event_name == 'pull_request'
    steps:
      - name: Wait for deployment
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300

  branch-check:
    runs-on: ubuntu-latest
    name: Check Branch Status
    needs: wait-for-vercel
    if: |
      always() &&
      (needs.wait-for-vercel.result == 'success' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if branch is up to date
        env:
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "üîç Checking if branch is ready for merge..."

          # Fetch both branches
          git fetch origin "$BASE_REF"
          git fetch origin "$HEAD_REF"

          # Use the actual PR head commit, not the current checkout
          PR_HEAD="origin/$HEAD_REF"
          BASE_HEAD="origin/$BASE_REF"

          echo "PR branch: $PR_HEAD ($(git rev-parse --short "$PR_HEAD"))"
          echo "Base branch: $BASE_HEAD ($(git rev-parse --short "$BASE_HEAD"))"

          # Check if PR branch is behind base
          BEHIND_COUNT=$(git rev-list --count "$PR_HEAD".."$BASE_HEAD")

          echo "Commits behind $BASE_REF: $BEHIND_COUNT"

          if [ "$BEHIND_COUNT" -gt 0 ]; then
            echo "‚ùå PR branch is $BEHIND_COUNT commits behind $BASE_REF"
            echo "Missing commits:"
            git log --oneline "$PR_HEAD".."$BASE_HEAD"
            echo "Please update your branch before running checks"
            exit 1
          fi

          echo "‚úÖ Branch is ready for merge into $BASE_REF"

  setup:
    runs-on: ubuntu-latest
    name: Setup Dependencies
    needs: branch-check
    if: always() && (needs.branch-check.result == 'success' || needs.branch-check.result == 'skipped')
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - uses: oven-sh/setup-bun@v2

      - name: Cache node_modules
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-${{ github.head_ref || github.ref_name }}-${{ hashFiles('bun.lock') }}

      - name: Install dependencies
        run: bun install

  build:
    runs-on: ubuntu-latest
    name: Build
    needs: setup
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - uses: oven-sh/setup-bun@v2

      - name: Restore dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-${{ github.head_ref || github.ref_name }}-${{ hashFiles('bun.lock') }}

      - name: Install dependencies (if cache miss)
        run: bun install

      - name: Cache Next.js build
        uses: actions/cache@v5
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ github.head_ref || github.ref_name }}-${{ hashFiles('src/**/*', 'package.json', 'bun.lock') }}

      - name: Build
        run: bun run build

  typecheck:
    runs-on: ubuntu-latest
    name: TypeScript Type Checking
    needs: build
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - uses: oven-sh/setup-bun@v2

      - name: Restore dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-${{ github.head_ref || github.ref_name }}-${{ hashFiles('bun.lock') }}

      - name: Install dependencies (if cache miss)
        run: bun install

      - name: TypeScript Type Check
        run: bun run typecheck

  lint:
    runs-on: ubuntu-latest
    name: Code Linting
    needs: build
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - uses: oven-sh/setup-bun@v2

      - name: Restore dependencies
        uses: actions/cache@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-bun-${{ github.head_ref || github.ref_name }}-${{ hashFiles('bun.lock') }}

      - name: Install dependencies (if cache miss)
        run: bun install

      - name: Lint
        run: bun run lint

  summary:
    runs-on: ubuntu-latest
    name: Checks Summary
    needs: [wait-for-vercel, branch-check, build, typecheck, lint]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.typecheck.result }}" == "success" && "${{ needs.lint.result }}" == "success" ]]; then
            echo "‚úÖ All checks passed!"
            echo "- Build: ‚úÖ"
            echo "- TypeScript type checking: ‚úÖ"
            echo "- Code linting: ‚úÖ"
          else
            echo "‚ùå Some checks failed:"
            echo "- Build: ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }}"
            echo "- TypeScript type checking: ${{ needs.typecheck.result == 'success' && '‚úÖ' || '‚ùå' }}"
            echo "- Code linting: ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }}"
            exit 1
          fi
